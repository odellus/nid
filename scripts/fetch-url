#!/usr/bin/env python3
"""Fetch URLs and extract content as markdown"""
import sys
import httpx
import readabilipy.simple_json
import markdownify


DEFAULT_USER_AGENT = "CrowAgent/1.0"


def fetch_url(url: str, user_agent: str = DEFAULT_USER_AGENT, raw: bool = False) -> str:
    """Fetch URL and return content."""
    with httpx.Client(follow_redirects=True) as client:
        response = client.get(
            url,
            headers={"User-Agent": user_agent},
            timeout=30,
        )
        response.raise_for_status()
        page_raw = response.text

    content_type = response.headers.get("content-type", "")
    is_html = (
        "<html" in page_raw[:100] or "text/html" in content_type or not content_type
    )

    if raw:
        return page_raw
    
    if is_html:
        ret = readabilipy.simple_json.simple_json_from_html_string(
            page_raw, use_readability=True
        )
        if ret.get("content"):
            content = markdownify.markdownify(
                ret["content"], heading_style=markdownify.ATX
            )
            return content
        return "<error>Failed to parse HTML</error>"
    else:
        return page_raw


def main():
    if len(sys.argv) < 2:
        print("Usage: fetch-url <url> [--raw] [--max-length N]")
        print("\nFetches URL and extracts content as markdown")
        print("\nOptions:")
        print("  --raw          Return raw HTML instead of markdown")
        print("  --max-length N Truncate to N characters (default: show all)")
        sys.exit(1)
    
    url = sys.argv[1]
    raw = "--raw" in sys.argv
    
    max_length = None
    for i, arg in enumerate(sys.argv):
        if arg == "--max-length" and i + 1 < len(sys.argv):
            max_length = int(sys.argv[i + 1])
            break
    
    try:
        content = fetch_url(url, raw=raw)
        
        if max_length:
            content = content[:max_length]
            if len(content) == max_length:
                content += f"\n\n[Truncated at {max_length} characters]"
        
        print(content)
    except Exception as e:
        print(f"Error fetching {url}: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
